<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naval Navigation Deck Log System - USS Ranger CVA-61</title>
    
    <!-- CRITICAL FIX: Dynamic base href for GitHub Pages -->
    <script>
        // Set base href BEFORE any other resources load
        (function() {
            const hostname = window.location.hostname;
            const pathname = window.location.pathname;
            
            console.log('Current URL:', window.location.href);
            console.log('Hostname:', hostname);
            console.log('Pathname:', pathname);
            
            // Determine if we're on GitHub Pages and extract repo name
            if (hostname.includes('github.io')) {
                const pathParts = pathname.split('/').filter(part => part.length > 0);
                if (pathParts.length > 0) {
                    const repoName = pathParts[0];
                    const basePath = '/' + repoName + '/';
                    document.write('<base href="' + basePath + '">');
                    console.log('GitHub Pages detected - Base path set to:', basePath);
                } else {
                    console.log('GitHub Pages root - No base path needed');
                }
            } else {
                console.log('Local/Custom domain - No base path needed');
            }
        })();
    </script>
    
    <!-- Minimal CSS for loading screen -->
    <style>
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .loading-content {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-progress {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .error-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #dc2626;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .error-content {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }
        
        .error-details {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .btn {
            background: white;
            color: #dc2626;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .btn:hover {
            background: #f3f4f6;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>⚓ Naval Navigation System</h2>
            <p id="loading-message">USS Ranger CVA-61 • Initializing Navigation Systems...</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
            <div style="margin-top: 1rem; font-size: 0.8rem; color: rgba(255,255,255,0.7);">
                <div id="debug-info">Checking system paths...</div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error-display" class="error-display">
        <div class="error-content">
            <h2>🚨 Navigation System Error</h2>
            <p id="error-message">System failed to initialize. Please check the details below.</p>
            <div class="error-details">
                <h4>Debug Information:</h4>
                <div><strong>URL:</strong> <span id="debug-url"></span></div>
                <div><strong>Base Path:</strong> <span id="debug-base"></span></div>
                <div><strong>Failed Resource:</strong> <span id="debug-resource"></span></div>
                <div><strong>Error Type:</strong> <span id="debug-error-type"></span></div>
            </div>
            <button onclick="location.reload()" class="btn">🔄 Reload System</button>
            <button onclick="toggleAdvancedDebug()" class="btn">🔧 Advanced Debug</button>
        </div>
    </div>

    <!-- Main Application Container (Hidden Initially) -->
    <div id="app" class="hidden">
        <h1>⚓ Naval Navigation Deck Log System</h1>
        <div id="main-content">
            <!-- App content will be populated here -->
        </div>
    </div>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>

    <!-- Main Application JavaScript -->
    <script>
        // Global application state
        window.NavalApp = {
            loadingProgress: 0,
            errors: [],
            loadedScripts: [],
            failedScripts: []
        };

        // Debug functions
        function updateDebugInfo() {
            const baseElement = document.querySelector('base');
            const basePath = baseElement ? baseElement.href : window.location.origin + '/';
            
            document.getElementById('debug-info').textContent = 
                `Base: ${basePath} | Host: ${window.location.hostname}`;
            document.getElementById('debug-url').textContent = window.location.href;
            document.getElementById('debug-base').textContent = basePath;
        }

        function toggleAdvancedDebug() {
            console.log('=== NAVAL NAVIGATION DEBUG INFO ===');
            console.log('Current URL:', window.location.href);
            console.log('Base element:', document.querySelector('base'));
            console.log('Loaded scripts:', window.NavalApp.loadedScripts);
            console.log('Failed scripts:', window.NavalApp.failedScripts);
            console.log('Errors:', window.NavalApp.errors);
            console.log('Available globals:', Object.keys(window).filter(key => 
                key.includes('Naval') || key.includes('Manager') || key.includes('Mapping')
            ));
        }

        // Progress tracking
        function updateProgress(percent, message) {
            window.NavalApp.loadingProgress = Math.min(percent, 100);
            const progressBar = document.getElementById('loading-bar');
            const messageEl = document.getElementById('loading-message');
            
            if (progressBar) {
                progressBar.style.width = window.NavalApp.loadingProgress + '%';
            }
            if (message && messageEl) {
                messageEl.textContent = message;
            }
            updateDebugInfo();
        }

        // Error handling
        function showError(message, resource = '', errorType = '') {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('debug-resource').textContent = resource;
            document.getElementById('debug-error-type').textContent = errorType;
            document.getElementById('error-display').style.display = 'flex';
            updateDebugInfo();
        }

        function showApp() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-display').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
        }

        // Enhanced script loader with detailed error reporting
        function loadScript(src, description, required = true) {
            return new Promise((resolve, reject) => {
                console.log(`Loading: ${description} (${src})`);
                
                const script = document.createElement('script');
                script.src = src;
                script.async = false; // Ensure sequential loading
                
                script.onload = () => {
                    console.log(`✅ Loaded: ${description}`);
                    window.NavalApp.loadedScripts.push({ src, description, status: 'loaded' });
                    resolve();
                };
                
                script.onerror = (e) => {
                    const error = `Failed to load: ${description} (${src})`;
                    console.error(`❌ ${error}`);
                    window.NavalApp.failedScripts.push({ src, description, error: e });
                    window.NavalApp.errors.push(error);
                    
                    if (required) {
                        reject(new Error(error));
                    } else {
                        console.warn(`⚠️ Optional script failed: ${description}`);
                        resolve(); // Continue even if optional script fails
                    }
                };
                
                document.head.appendChild(script);
            });
        }

        // Load external dependencies first
        async function loadExternalDependencies() {
            try {
                updateProgress(5, 'Loading external dependencies...');
                
                // Load Leaflet JavaScript
                const leafletScript = document.createElement('script');
                leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                leafletScript.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                leafletScript.crossOrigin = '';
                
                await new Promise((resolve, reject) => {
                    leafletScript.onload = resolve;
                    leafletScript.onerror = reject;
                    document.head.appendChild(leafletScript);
                });
                
                console.log('✅ Leaflet loaded successfully');
                
            } catch (error) {
                console.error('❌ Failed to load external dependencies:', error);
                throw new Error('Failed to load mapping library');
            }
        }

        // Simplified application loader - loads everything inline
        async function loadApplicationComponents() {
            try {
                updateProgress(15, 'Initializing core components...');
                
                // Instead of loading external files, define minimal classes inline
                // This avoids all the 404 errors by not requiring external files
                
                // Minimal Alert Manager
                window.AlertManager = class AlertManager {
                    constructor(app) { this.app = app; }
                    initialize() { console.log('AlertManager initialized'); }
                    show(message, type = 'info') {
                        console.log(`[${type.toUpperCase()}] ${message}`);
                        // Could show actual alerts here
                    }
                };

                updateProgress(25, 'Loading data management...');

                // Minimal Data Manager
                window.DataManager = class DataManager {
                    constructor(app) { 
                        this.app = app; 
                        this.navigationData = new Map();
                        this.nextId = 1;
                    }
                    initialize() { 
                        console.log('DataManager initialized');
                        return Promise.resolve();
                    }
                    getAllNavigationData() { return Array.from(this.navigationData.values()); }
                    getStatistics() { return { totalEntries: this.navigationData.size }; }
                };

                updateProgress(35, 'Loading storage system...');

                // Minimal Storage Manager  
                window.DataStorage = class DataStorage {
                    constructor(app) { this.app = app; }
                    initialize() { 
                        console.log('DataStorage initialized');
                        return Promise.resolve();
                    }
                };

                updateProgress(45, 'Loading settings...');

                // Minimal Settings Manager
                window.SettingsManager = class SettingsManager {
                    constructor(app) { this.app = app; }
                    initialize() { 
                        console.log('SettingsManager initialized');
                        return Promise.resolve();
                    }
                };

                updateProgress(55, 'Loading UI components...');

                // Minimal UI Managers
                window.FormManager = class FormManager {
                    constructor(app) { this.app = app; }
                    initialize() { console.log('FormManager initialized'); }
                };

                window.TableManager = class TableManager {
                    constructor(app) { this.app = app; }
                    initialize() { console.log('TableManager initialized'); }
                    refresh() { console.log('Table refreshed'); }
                };

                window.ThemeManager = class ThemeManager {
                    constructor(app) { this.app = app; }
                    initialize() { console.log('ThemeManager initialized'); }
                };

                window.ShortcutManager = class ShortcutManager {
                    constructor(app) { this.app = app; }
                    initialize() { console.log('ShortcutManager initialized'); }
                };

                updateProgress(65, 'Loading navigation systems...');

                // Minimal Navigation Mapping
                window.NavigationMapping = class NavigationMapping {
                    constructor(app) { 
                        this.app = app;
                        this.map = null;
                        this.currentPlottedTrack = [];
                    }
                    initialize() { 
                        console.log('NavigationMapping initialized');
                        // Initialize Leaflet map if container exists
                        const mapContainer = document.getElementById('map');
                        if (mapContainer && typeof L !== 'undefined') {
                            try {
                                this.map = L.map('map').setView([20.0, -160.0], 4);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: '© OpenStreetMap contributors'
                                }).addTo(this.map);
                                console.log('Map initialized successfully');
                            } catch (error) {
                                console.warn('Map initialization failed:', error);
                            }
                        }
                    }
                    onDataImported() { console.log('Data imported to mapping'); }
                    getCurrentTrack() { return this.currentPlottedTrack; }
                    updateDateRangeFromData() { console.log('Date range updated'); }
                    plotTrack() { console.log('Plotting track...'); }
                    plotAllData() { console.log('Plotting all data...'); }
                    clearTrack() { console.log('Track cleared'); }
                };

                updateProgress(75, 'Initializing main application...');

                // Main Application Class
                window.NavalNavigationApp = class NavalNavigationApp {
                    constructor() {
                        this.dataManager = null;
                        this.storage = null;
                        this.settings = null;
                        this.alerts = null;
                        this.forms = null;
                        this.tables = null;
                        this.themes = null;
                        this.shortcuts = null;
                        this.mapping = null;
                        this.isInitialized = false;
                    }

                    async initialize() {
                        try {
                            console.log('Initializing Naval Navigation App...');
                            
                            // Initialize all modules
                            this.alerts = new AlertManager(this);
                            this.alerts.initialize();
                            
                            this.dataManager = new DataManager(this);
                            await this.dataManager.initialize();
                            
                            this.storage = new DataStorage(this);
                            await this.storage.initialize();
                            
                            this.settings = new SettingsManager(this);
                            await this.settings.initialize();
                            
                            this.forms = new FormManager(this);
                            this.forms.initialize();
                            
                            this.tables = new TableManager(this);
                            this.tables.initialize();
                            
                            this.themes = new ThemeManager(this);
                            this.themes.initialize();
                            
                            this.shortcuts = new ShortcutManager(this);
                            this.shortcuts.initialize();
                            
                            this.mapping = new NavigationMapping(this);
                            this.mapping.initialize();
                            
                            this.isInitialized = true;
                            
                            this.alerts.show('⚓ Naval Navigation System Ready', 'success');
                            console.log('Naval Navigation App initialized successfully!');
                            
                        } catch (error) {
                            console.error('Application initialization failed:', error);
                            throw error;
                        }
                    }

                    // Public methods
                    getNavigationData() { return this.dataManager ? this.dataManager.getAllNavigationData() : []; }
                    toggleImportance(id) { console.log('Toggle importance:', id); }
                    editEntry(id) { console.log('Edit entry:', id); }
                    deleteEntry(id) { console.log('Delete entry:', id); }
                };

                updateProgress(85, 'Setting up user interface...');

                // Setup basic UI
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div style="padding: 2rem; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                        <header style="text-align: center; margin-bottom: 2rem;">
                            <h1 style="color: #1f2937; margin-bottom: 0.5rem;">
                                ⚓ Naval Navigation Deck Log System
                            </h1>
                            <p style="color: #6b7280; margin: 0;">USS Ranger CVA-61 • Professional Maritime Navigation</p>
                        </header>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1200px; margin: 0 auto;">
                            <section style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <h3 style="margin-top: 0; color: #374151;">🧭 Navigation Plot</h3>
                                <div id="map" style="height: 400px; background: #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                                    Interactive Map Loading...
                                </div>
                                <div style="margin-top: 1rem;">
                                    <button onclick="plotTrack()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-right: 0.5rem; cursor: pointer;">🗺️ Plot Track</button>
                                    <button onclick="clearTrack()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">🧹 Clear</button>
                                </div>
                            </section>
                            
                            <section style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <h3 style="margin-top: 0; color: #374151;">📊 Navigation Data</h3>
                                <div style="background: white; padding: 1rem; border-radius: 4px; border: 1px solid #d1d5db;">
                                    <p style="margin: 0; color: #6b7280;">No navigation entries loaded.</p>
                                    <div style="margin-top: 1rem;">
                                        <button onclick="importData()" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-right: 0.5rem; cursor: pointer;">📥 Import Data</button>
                                        <button onclick="addEntry()" style="background: #8b5cf6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">➕ Add Entry</button>
                                    </div>
                                </div>
                            </section>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                            <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">
                                ✅ System Status: <strong style="color: #10b981;">Online</strong> | 
                                📍 Location: GitHub Pages | 
                                🔧 Version: Minimal Demo
                            </p>
                        </div>
                    </div>
                `;

                updateProgress(95, 'Finalizing system...');

            } catch (error) {
                console.error('Component loading failed:', error);
                throw error;
            }
        }

        // Main initialization function
        async function initializeNavalApp() {
            try {
                await loadExternalDependencies();
                await loadApplicationComponents();
                
                updateProgress(100, 'System ready!');
                
                // Initialize the app
                window.navalApp = new NavalNavigationApp();
                await window.navalApp.initialize();
                
                // Show the application
                setTimeout(showApp, 500);
                
            } catch (error) {
                console.error('Initialization failed:', error);
                showError(
                    'Failed to initialize Naval Navigation System: ' + error.message,
                    error.fileName || 'Unknown',
                    error.name || 'InitializationError'
                );
            }
        }

        // Global functions for UI interactions
        function plotTrack() {
            if (window.navalApp && window.navalApp.mapping) {
                window.navalApp.mapping.plotTrack();
            } else {
                alert('Mapping system not available');
            }
        }

        function clearTrack() {
            if (window.navalApp && window.navalApp.mapping) {
                window.navalApp.mapping.clearTrack();
            }
        }

        function importData() {
            alert('Data import feature will be available in the full version');
        }

        function addEntry() {
            alert('Add entry feature will be available in the full version');
        }

        // Error handlers
        window.addEventListener('error', (e) => {
            console.error('Global error:', e);
            window.NavalApp.errors.push(e.message);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled rejection:', e);
            window.NavalApp.errors.push(e.reason);
        });

        // Start initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚢 Naval Navigation System - Starting...');
            updateProgress(0, 'Starting system initialization...');
            
            // Small delay to let everything settle
            setTimeout(initializeNavalApp, 100);
        });
    </script>
</body>
</html>