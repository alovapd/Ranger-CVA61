<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naval Navigation Deck Log System - USS Ranger CVA-61</title>
    
    <!-- CRITICAL: Base href for GitHub Pages path resolution -->
    <script>
        // Dynamically set base href for GitHub Pages compatibility
        (function() {
            const path = window.location.pathname;
            let basePath = '';
            
            // Check if we're on GitHub Pages (contains github.io)
            if (window.location.hostname.includes('github.io')) {
                // Extract repository name from path for GitHub Pages
                const pathParts = path.split('/').filter(part => part.length > 0);
                if (pathParts.length > 0) {
                    basePath = '/' + pathParts[0] + '/';
                }
            }
            
            // Set base href
            if (basePath) {
                document.write('<base href="' + basePath + '">');
                console.log('[GitHub Pages] Base path set to:', basePath);
            } else {
                console.log('[Local] No base path needed');
            }
        })();
    </script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <!-- Meta Tags for SEO and Social -->
    <meta name="description" content="Professional maritime navigation logging system for USS Ranger CVA-61, featuring interactive mapping, coordinate tracking, and historical data visualization.">
    <meta name="keywords" content="naval navigation, maritime, USS Ranger, navigation log, coordinates, mapping">
    <meta name="author" content="Naval Navigation System">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Naval Navigation Deck Log System">
    <meta property="og:description" content="Professional maritime navigation logging system for USS Ranger CVA-61">
    <meta property="og:image" content="assets/og-image.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Naval Navigation Deck Log System">
    <meta property="twitter:description" content="Professional maritime navigation logging system for USS Ranger CVA-61">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>‚öì Naval Navigation System</h2>
            <p>USS Ranger CVA-61 ‚Ä¢ Initializing Navigation Systems...</p>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
            <div class="loading-debug">
                <small id="debug-info">Checking system paths...</small>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error-display" class="error-display" style="display: none;">
        <div class="error-content">
            <h2>üö® System Error</h2>
            <p id="error-message">Navigation system failed to initialize. Please check console for details.</p>
            <div class="error-details">
                <h4>Debug Information:</h4>
                <p><strong>URL:</strong> <span id="debug-url"></span></p>
                <p><strong>Base Path:</strong> <span id="debug-base"></span></p>
                <p><strong>Hostname:</strong> <span id="debug-hostname"></span></p>
            </div>
            <button onclick="location.reload()" class="btn btn-primary">Reload System</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title">
                        <span class="ship-icon">‚öì</span>
                        Naval Navigation Deck Log
                        <span class="ship-designation">USS Ranger CVA-61</span>
                    </h1>
                </div>
                <div class="header-right">
                    <div class="status-indicator" id="system-status">
                        <span class="status-dot online"></span>
                        <span class="status-text">System Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Alert Container -->
        <div id="alert-container" class="alert-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Navigation Panel -->
            <section class="panel navigation-panel">
                <div class="panel-header">
                    <h3>üß≠ Navigation Plot</h3>
                </div>
                <div class="panel-content">
                    <!-- Map Container -->
                    <div id="map" class="map-container"></div>
                    
                    <!-- Plot Controls -->
                    <div class="plot-controls">
                        <div class="date-range-container">
                            <h4>üìÖ Plot Date Range</h4>
                            <div class="date-inputs">
                                <div class="input-group">
                                    <label for="plot-start-date">From:</label>
                                    <input type="date" id="plot-start-date" class="form-control date-input">
                                </div>
                                <div class="input-group">
                                    <label for="plot-end-date">To:</label>
                                    <input type="date" id="plot-end-date" class="form-control date-input">
                                </div>
                            </div>
                            <div class="plot-buttons">
                                <button id="plot-track-btn" class="btn btn-primary">üó∫Ô∏è Plot Track</button>
                                <button id="plot-all-btn" class="btn btn-secondary">üìç Plot All Data</button>
                                <button id="clear-track-btn" class="btn btn-outline">üßπ Clear Track</button>
                            </div>
                        </div>
                        
                        <!-- System Controls -->
                        <div class="system-controls">
                            <h4>‚öôÔ∏è System Controls</h4>
                            <div class="control-buttons">
                                <button id="theme-btn" class="btn btn-outline">üé® Theme</button>
                                <button id="settings-btn" class="btn btn-outline">‚öôÔ∏è Settings</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Data Management Panel -->
            <section class="panel data-panel">
                <div class="panel-header">
                    <h3>üìä Navigation Data</h3>
                    <div class="panel-stats">
                        <span id="data-count" data-stat="totalEntries">0 entries</span>
                    </div>
                </div>
                
                <!-- Data Controls -->
                <div class="data-controls">
                    <div class="control-group">
                        <button id="add-entry-btn" class="btn btn-primary">‚ûï Add Entry</button>
                        <button id="import-data-btn" class="btn btn-secondary">üì• Import Data</button>
                        <button id="export-data-btn" class="btn btn-outline">üì§ Export Data</button>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="search-controls">
                        <input type="text" id="search-input" class="form-control" placeholder="üîç Search navigation entries...">
                        <select id="filter-importance" class="form-control">
                            <option value="all">All Entries</option>
                            <option value="important">‚≠ê Important Only</option>
                            <option value="normal">Standard Entries</option>
                        </select>
                    </div>
                </div>

                <!-- Data Table Container -->
                <div class="table-container">
                    <div id="navigation-table" class="navigation-table">
                        <!-- Table will be populated by JavaScript -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Entry Form Modal -->
        <div id="entry-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Add Navigation Entry</h3>
                    <button class="modal-close" id="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="navigation-form" class="navigation-form">
                        <!-- Form fields will be populated by JavaScript -->
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚öôÔ∏è System Settings</h3>
                    <button class="modal-close" id="settings-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="settings-content">
                        <!-- Settings will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- File Input (Hidden) -->
        <input type="file" id="file-input" accept=".json,.csv" style="display: none;">
    </div>

    <!-- JavaScript Libraries -->
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <!-- Application JavaScript - Path-aware loading -->
    <script>
        // Global configuration
        window.NavalApp = window.NavalApp || {};
        
        // Debug info for troubleshooting
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            const baseElement = document.querySelector('base');
            const basePath = baseElement ? baseElement.href : 'none';
            
            if (debugInfo) {
                debugInfo.textContent = `Base: ${basePath} | Host: ${window.location.hostname}`;
            }
            
            // Update error display debug info
            document.getElementById('debug-url').textContent = window.location.href;
            document.getElementById('debug-base').textContent = basePath;
            document.getElementById('debug-hostname').textContent = window.location.hostname;
        }
        
        // Global error handler with better debugging
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });
            showInitializationError('JavaScript error: ' + e.message + ' (File: ' + e.filename + ')');
        });

        // Enhanced error handler for network errors (404s)
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e);
            showInitializationError('Network error: ' + e.reason);
        });

        // Show initialization error with debug info
        function showInitializationError(message) {
            updateDebugInfo();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-display').style.display = 'flex';
        }

        // Hide loading screen and show app
        function showApplication() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-display').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        // Initialize loading progress
        let loadingProgress = 0;
        const progressBar = document.querySelector('.loading-bar');
        
        function updateProgress(percent, message) {
            loadingProgress = Math.min(percent, 100);
            if (progressBar) {
                progressBar.style.width = loadingProgress + '%';
            }
            if (message) {
                const loadingText = document.querySelector('.loading-content p');
                if (loadingText) {
                    loadingText.textContent = message;
                }
            }
            updateDebugInfo();
        }

        // Helper function to load script with error handling
        function loadScript(src, description) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${description} (${src})`);
                    resolve();
                };
                script.onerror = (e) => {
                    console.error(`‚ùå Failed to load: ${description} (${src})`);
                    console.error('Script error details:', e);
                    reject(new Error(`Failed to load ${description}: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // Sequential script loading with better error handling
        async function loadApplicationScripts() {
            try {
                updateProgress(10, 'Loading configuration...');
                await loadScript('js/config.js', 'Configuration');

                updateProgress(20, 'Loading core modules...');
                await loadScript('js/core/data-manager.js', 'Data Manager');
                await loadScript('js/core/storage.js', 'Storage Manager');
                await loadScript('js/core/settings.js', 'Settings Manager');

                updateProgress(40, 'Loading UI components...');
                await loadScript('js/ui/alerts.js', 'Alert Manager');
                await loadScript('js/ui/forms.js', 'Form Manager');
                await loadScript('js/ui/tables.js', 'Table Manager');
                await loadScript('js/ui/themes.js', 'Theme Manager');
                await loadScript('js/ui/shortcuts.js', 'Shortcut Manager');

                updateProgress(60, 'Loading navigation systems...');
                await loadScript('js/navigation/coordinates.js', 'Coordinate System');
                await loadScript('js/navigation/distance.js', 'Distance Calculator');
                await loadScript('js/navigation/mapping.js', 'Navigation Mapping');

                updateProgress(80, 'Loading application data...');
                await loadScript('data/landmass.js', 'Landmass Data');

                updateProgress(90, 'Initializing application...');
                await loadScript('js/core/app.js', 'Main Application');

                updateProgress(95, 'Starting navigation system...');
                
                // Initialize the application
                setTimeout(async function() {
                    try {
                        if (typeof NavalNavigationApp === 'undefined') {
                            throw new Error('NavalNavigationApp class not found - check that all scripts loaded correctly');
                        }
                        
                        // Create and initialize app
                        window.navalApp = new NavalNavigationApp();
                        await window.navalApp.initialize();
                        
                        updateProgress(100, 'System ready!');
                        setTimeout(showApplication, 500);
                        
                    } catch (error) {
                        console.error('Application initialization failed:', error);
                        showInitializationError('Failed to initialize: ' + error.message);
                    }
                }, 200);

            } catch (error) {
                console.error('Script loading failed:', error);
                showInitializationError('Failed to load application scripts: ' + error.message);
            }
        }

        // Start loading when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üö¢ Naval Navigation System - Starting initialization...');
            console.log('URL:', window.location.href);
            console.log('Hostname:', window.location.hostname);
            console.log('Pathname:', window.location.pathname);
            
            const baseElement = document.querySelector('base');
            if (baseElement) {
                console.log('Base href:', baseElement.href);
            }
            
            // Start script loading
            loadApplicationScripts();
        });

        // Service Worker Registration (PWA) with path awareness
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Determine service worker path based on base href
                const baseElement = document.querySelector('base');
                let swPath = 'service-worker.js';
                
                if (baseElement) {
                    const basePath = new URL(baseElement.href).pathname;
                    swPath = basePath + 'service-worker.js';
                }
                
                navigator.serviceWorker.register(swPath)
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <!-- Add Clear Track Button Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure app is initialized
            setTimeout(function() {
                const clearTrackBtn = document.getElementById('clear-track-btn');
                if (clearTrackBtn) {
                    clearTrackBtn.addEventListener('click', function() {
                        if (window.navalApp && window.navalApp.mapping) {
                            window.navalApp.mapping.clearTrack();
                        }
                    });
                }
            }, 1000);
        });
    </script>
</body>
</html>